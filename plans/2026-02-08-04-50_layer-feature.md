# ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½ã®è¿½åŠ 

> ä¿å­˜å…ˆ: `/plans/2026-02-08-04-50_layer-feature.md`

## Context

ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã¯ committed + pending ã®2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã§å‹•ä½œã—ã¦ã„ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§æç”»ã§ãã‚‹ã‚ˆã†ã«ã—ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã¹æ›¿ãˆãƒ»å¯è¦–åˆ‡æ›¿ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€‚ã‚¨ãƒ³ã‚¸ãƒ³è‡ªä½“ã¯æ—¢ã« `renderLayers` ã«ã‚ˆã‚‹è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãŒã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«IDãŒãªãã€å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã‚‚å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰æã€‚

### æ±ºå®šæ¸ˆã¿ä»•æ§˜

- **Undo/Redo**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆå…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¨ªæ–­ã®1æœ¬ã®å±¥æ­´ï¼‰
- **èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼**: æç”»ä¸å¯ã€‚BackgroundSettingsã®ã¾ã¾ãƒ‘ãƒãƒ«è¡¨ç¤ºï¼ˆè‰²å¤‰æ›´ãƒ»è¡¨ç¤ºåˆ‡æ›¿ã®ã¿ï¼‰
- **æ“ä½œã‚¹ã‚³ãƒ¼ãƒ—**: è¿½åŠ ãƒ»å‰Šé™¤ãƒ»å¯è¦–åˆ‡æ›¿ãƒ»ä¸¦ã¹æ›¿ãˆï¼ˆãƒœã‚¿ãƒ³å¼ï¼‰ã®ã¿ã€‚opacity/blend/rename/mergeã¯å¾Œå›ã—
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼0æš**: è¨±å®¹ï¼ˆèƒŒæ™¯ã®ã¿çŠ¶æ…‹ã€‚æç”»ä¸å¯ï¼‰
- **ãƒšãƒ³/å¯¾ç§°/å±¥æ­´è¨­å®š**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥è¨­å®šãªã—ï¼‰
- **å±¥æ­´å¯¾è±¡ã®æ“ä½œ**: æç”»ç³»ï¼ˆstroke / clear / wrap-shiftï¼‰+ æ§‹é€ ç³»ï¼ˆadd-layer / remove-layer / reorder-layerï¼‰
- **å±¥æ­´å¯¾è±¡å¤–**: å¯è¦–åˆ‡æ›¿ï¼ˆè¡¨ç¤ºç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãŸã‚ï¼‰
- **ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®Undo/Redo**: æç”»ã‚³ãƒãƒ³ãƒ‰ã®Undo/Redoã§ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹å ´åˆã€è‡ªå‹•çš„ã«å¯è¦–ã«å¤‰æ›´
- **å‰Šé™¤æ™‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**: `remove-layer` ã‚³ãƒãƒ³ãƒ‰è¿½åŠ æ™‚ã€å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å¼·åˆ¶ä½œæˆï¼ˆ`checkpointInterval` ã‚’ç„¡è¦–ï¼‰ã€‚`maxCheckpoints` ã®é€šå¸¸ã®æŠ¼ã—å‡ºã—ãƒ«ãƒ¼ãƒ«ã¯ãã®ã¾ã¾é©ç”¨

---

## Phase 1: APIè¨­è¨ˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

### 1-1. Engine: `Layer` ã« `id` è¿½åŠ 

**[types.ts](packages/engine/src/types.ts)**

```typescript
export interface Layer {
  readonly id: string;        // NEW
  readonly width: number;
  readonly height: number;
  readonly canvas: OffscreenCanvas;
  readonly ctx: OffscreenCanvasRenderingContext2D;
  readonly meta: LayerMeta;
}
```

**[layer.ts](packages/engine/src/layer.ts)**: `createLayer` ã§IDè‡ªå‹•ç”Ÿæˆ

```typescript
let layerIdCounter = 0;
function generateLayerId(): string {
  return `layer_${Date.now()}_${++layerIdCounter}`;
}
```

### 1-2. Engine: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒ«ãƒ‘ãƒ¼

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: [layer-collection.ts](packages/engine/src/layer-collection.ts)**

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯ `readonly Layer[]` ã®ã¾ã¾ã€‚ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤:

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `addLayer(layers, width, height, meta?, insertIndex?)` | `[updatedLayers, newLayer]` ã‚’è¿”ã™ |
| `removeLayer(layers, layerId)` | IDæŒ‡å®šã§å‰Šé™¤ |
| `findLayerById(layers, layerId)` | IDæ¤œç´¢ |
| `getLayerIndex(layers, layerId)` | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å–å¾— |
| `moveLayer(layers, fromIndex, toIndex)` | ä¸¦ã¹æ›¿ãˆ |
| `updateLayerMeta(layers, layerId, metaUpdate)` | metaæ›´æ–°ï¼ˆæ–°é…åˆ—ã‚’è¿”ã™ï¼‰ |

### 1-3. Stroke: Command ä½“ç³»ã®æ‹¡å¼µ

**[types.ts](packages/stroke/src/types.ts)**

#### æç”»ã‚³ãƒãƒ³ãƒ‰ï¼ˆæ—¢å­˜ï¼‰ã« `layerId` è¿½åŠ 

```typescript
export interface StrokeCommand {
  readonly type: "stroke";
  readonly layerId: string;    // NEW
  // ...æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}
export interface ClearCommand {
  readonly type: "clear";
  readonly layerId: string;    // NEW
  readonly timestamp: number;
}
export interface WrapShiftCommand {
  readonly type: "wrap-shift";
  readonly layerId: string;    // NEW
  // ...æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}

export type DrawCommand = StrokeCommand | ClearCommand | WrapShiftCommand;
```

#### æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ï¼ˆæ–°è¦ï¼‰

```typescript
export interface AddLayerCommand {
  readonly type: "add-layer";
  readonly layerId: string;
  readonly insertIndex: number;
  readonly width: number;
  readonly height: number;
  readonly meta: LayerMeta;
  readonly timestamp: number;
}

export interface RemoveLayerCommand {
  readonly type: "remove-layer";
  readonly layerId: string;
  readonly removedIndex: number;   // undoæ™‚ã®å†æŒ¿å…¥ä½ç½®
  readonly timestamp: number;
}

export interface ReorderLayerCommand {
  readonly type: "reorder-layer";
  readonly layerId: string;
  readonly fromIndex: number;
  readonly toIndex: number;
  readonly timestamp: number;
}

export type StructuralCommand = AddLayerCommand | RemoveLayerCommand | ReorderLayerCommand;
```

#### çµ±åˆå‹

```typescript
export type Command = DrawCommand | StructuralCommand;

export function isDrawCommand(cmd: Command): cmd is DrawCommand {
  return cmd.type === "stroke" || cmd.type === "clear" || cmd.type === "wrap-shift";
}

export function isStructuralCommand(cmd: Command): cmd is StructuralCommand {
  return cmd.type === "add-layer" || cmd.type === "remove-layer" || cmd.type === "reorder-layer";
}
```

#### Checkpoint

`Checkpoint` ã« `layerId` è¿½åŠ :

```typescript
export interface Checkpoint {
  readonly id: string;
  readonly layerId: string;    // NEW
  readonly commandIndex: number;
  readonly imageData: ImageData;
  readonly createdAt: number;
}
```

`HistoryState` ã®å‹è‡ªä½“ã¯å¤‰æ›´ãªã—ã€‚

### 1-4. Stroke: ãƒãƒ«ãƒãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´API

**[history.ts](packages/stroke/src/history.ts)** ã«è¿½åŠ :

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `findBestCheckpointForLayer(state, layerId)` | ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€é©checkpoint |
| `getCommandsToReplayForLayer(state, layerId, checkpoint?)` | ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªãƒ—ãƒ¬ã‚¤å¯¾è±¡ã‚³ãƒãƒ³ãƒ‰ |
| `getAffectedLayerIds(state, fromIndex, toIndex)` | 2ã¤ã®indexé–“ã§å½±éŸ¿ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚»ãƒƒãƒˆ |
| `computeCumulativeOffsetForLayer(state, layerId)` | ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®wrap-shiftç´¯ç© |

**[replay.ts](packages/stroke/src/replay.ts)** ã«è¿½åŠ :

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `rebuildLayerFromHistory(layer, state)` | `layer.id` ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ãƒªãƒ“ãƒ«ãƒ‰ |

æ—¢å­˜ã® `rebuildLayerState` / `findBestCheckpoint` / `computeCumulativeOffset` ã¯å‰Šé™¤ï¼ˆç ´å£Šçš„å¤‰æ›´OKï¼‰ã€‚

### 1-5. Stroke: ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆé–¢æ•°ã®å¤‰æ›´

å…¨ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆé–¢æ•°ã«ç¬¬1å¼•æ•° `layerId: string` ã‚’è¿½åŠ :

```typescript
createStrokeCommand(layerId, inputPoints, filterPipeline, expand, ...)
createClearCommand(layerId)
createWrapShiftCommand(layerId, dx, dy)
endStrokeSession(state, layerId, inputPoints, filterPipeline)
```

### 1-6. `pushCommand` ã®å‹•ä½œ

ã‚·ã‚°ãƒãƒãƒ£å¤‰æ›´: `layer` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã«:

```typescript
pushCommand(
  state: HistoryState,
  command: Command,
  layer: Layer | null,
  config?: HistoryConfig,
): HistoryState
```

- **æç”»ã‚³ãƒãƒ³ãƒ‰**: `layer` ã¯ `command.layerId` ã«å¯¾å¿œã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€‚å¾“æ¥ã©ãŠã‚Š `checkpointInterval` ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆã€‚`createCheckpoint` ãŒ `layer.id` ã‚’checkpointã«è¨˜éŒ²
- **`remove-layer`**: `layer` ã¯å‰Šé™¤å¯¾è±¡ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€‚**ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å¼·åˆ¶ä½œæˆ**ï¼ˆ`checkpointInterval` ã‚’ç„¡è¦–ï¼‰ã€‚å‰Šé™¤Undoæ™‚ã«ã“ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰é«˜é€Ÿå¾©å…ƒã™ã‚‹
- **`add-layer` / `reorder-layer`**: `layer` ã¯ `null`ã€‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä¸è¦ï¼ˆãƒ”ã‚¯ã‚»ãƒ«å¤‰æ›´ãªã—ï¼‰

`maxCheckpoints` ã«ã‚ˆã‚‹é€šå¸¸ã®æŠ¼ã—å‡ºã—ãƒ«ãƒ¼ãƒ«ã¯ãã®ã¾ã¾é©ç”¨ã€‚

### 1-7. æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã®Undo/Redo

æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚’å¤‰æ›´ã—ãªã„ãŸã‚ã€`replayCommand` ã«ã¯å«ã‚ãªã„ã€‚Undo/Redoæ™‚ã«ã‚³ãƒãƒ³ãƒ‰ç¨®åˆ¥ã§åˆ†å²ã—ã€å‘¼ã³å‡ºã—å´ï¼ˆWeb Appï¼‰ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’æ“ä½œã™ã‚‹:

| ã‚³ãƒãƒ³ãƒ‰ | Undo | Redo |
|---------|------|------|
| `add-layer` | ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ | ãƒ¬ã‚¤ãƒ¤ãƒ¼å†ä½œæˆï¼ˆç©ºï¼‰ |
| `remove-layer` | ãƒ¬ã‚¤ãƒ¤ãƒ¼å†æŒ¿å…¥ + ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å¾©å…ƒ | ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ |
| `reorder-layer` | `toIndex â†’ fromIndex` ã«ç§»å‹•ï¼ˆé€†æ–¹å‘ï¼‰ | `fromIndex â†’ toIndex` ã«ç§»å‹• |

**`remove-layer` ã®Undoè©³ç´°**:

1. `removedIndex` ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å†ä½œæˆ
2. `remove-layer` ã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ç´ã¥ããƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æ¤œç´¢
3. è¦‹ã¤ã‹ã‚Œã° `restoreFromCheckpoint` ã§å³å¾©å…ƒ
4. è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ï¼ˆ`maxCheckpoints` ã§æŠ¼ã—å‡ºã—æ¸ˆã¿ï¼‰`rebuildLayerFromHistory` ã§ãƒ•ãƒ«ãƒªãƒ—ãƒ¬ã‚¤ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®è‡ªå‹•å¯è¦–åŒ–**: æç”»ã‚³ãƒãƒ³ãƒ‰ã®Undo/Redoã§ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹å ´åˆã€ãã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è‡ªå‹•çš„ã«å¯è¦–ã«å¤‰æ›´ã™ã‚‹ã€‚

---

## Phase 2: åˆ©ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ãƒ“ãƒ¥ãƒ¼

### Web App ã§ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ•ãƒ­ãƒ¼

```typescript
// --- useLayers hook ---
const {
  entries,          // readonly LayerEntry[] (id + committedLayer)
  activeLayerId,    // string | null
  activeEntry,      // LayerEntry | undefined (derived)
  addLayer, removeLayer, setActiveLayerId,
  toggleVisibility, moveLayerUp, moveLayerDown,
} = useLayers(LAYER_WIDTH, LAYER_HEIGHT);

// å…±æœ‰ pending layer
const pendingLayer = useMemo(() => createLayer(W, H), []);

// æç”»å¯å¦åˆ¤å®š
const canDraw = activeEntry != null && activeEntry.committedLayer.meta.visible;

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹æ™‚
const onStrokeStart = (point: InputPoint) => {
  if (!canDraw) return;
  // ...filter, session é–‹å§‹
  appendToCommittedLayer(activeEntry.committedLayer, ..., strokeStyle, compiled);
  renderPendingLayer(pendingLayer, ..., strokeStyle, compiled);
};

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ‚äº†æ™‚
const onStrokeEnd = () => {
  // ...
  const command = createStrokeCommand(
    activeLayerId!,  // layerId (ç¬¬1å¼•æ•°)
    inputPoints, filterPipeline.config, expand, ...
  );
  setHistoryState(prev =>
    pushCommand(prev, command, activeEntry!.committedLayer, HISTORY_CONFIG)
  );
};

// ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ï¼ˆæ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦å±¥æ­´ã«è¨˜éŒ²ï¼‰
const handleAddLayer = () => {
  const { entry, insertIndex } = addLayer();
  const command = createAddLayerCommand(
    entry.id, insertIndex, W, H, entry.committedLayer.meta
  );
  setHistoryState(prev => pushCommand(prev, command, null, HISTORY_CONFIG));
};

// ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ï¼ˆå‰Šé™¤å‰ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå¼·åˆ¶ä½œæˆï¼‰
const handleRemoveLayer = (layerId: string) => {
  const entry = findEntry(layerId);
  if (!entry) return;
  const removedIndex = getLayerIndex(layerId);
  const command = createRemoveLayerCommand(layerId, removedIndex);
  // pushCommand å†…ã§ entry.committedLayer ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å¼·åˆ¶ä½œæˆ
  setHistoryState(prev =>
    pushCommand(prev, command, entry.committedLayer, HISTORY_CONFIG)
  );
  removeLayerById(layerId);
};

// ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸¦ã¹æ›¿ãˆ
const handleMoveLayer = (layerId: string, direction: "up" | "down") => {
  const fromIndex = getLayerIndex(layerId);
  const toIndex = direction === "up" ? fromIndex + 1 : fromIndex - 1;
  const command = createReorderLayerCommand(layerId, fromIndex, toIndex);
  setHistoryState(prev => pushCommand(prev, command, null, HISTORY_CONFIG));
  moveLayer(fromIndex, toIndex);
};

// Undo
const handleUndo = () => {
  setHistoryState(prev => {
    if (!canUndo(prev)) return prev;
    const undoneCommand = prev.commands[prev.currentIndex];
    const newState = undo(prev);

    if (isStructuralCommand(undoneCommand)) {
      switch (undoneCommand.type) {
        case "add-layer":
          removeLayerById(undoneCommand.layerId);
          break;
        case "remove-layer": {
          // ãƒ¬ã‚¤ãƒ¤ãƒ¼å†æŒ¿å…¥ â†’ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å¾©å…ƒ
          const entry = reinsertLayer(undoneCommand.layerId, undoneCommand.removedIndex);
          const cp = newState.checkpoints.find(
            c => c.layerId === undoneCommand.layerId
              && c.commandIndex === prev.currentIndex
          );
          if (cp) {
            restoreFromCheckpoint(entry.committedLayer, cp);
          } else {
            rebuildLayerFromHistory(entry.committedLayer, newState);
          }
          break;
        }
        case "reorder-layer":
          moveLayer(undoneCommand.toIndex, undoneCommand.fromIndex);
          break;
      }
    } else {
      // æç”»ã‚³ãƒãƒ³ãƒ‰: å½±éŸ¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ãƒªãƒ“ãƒ«ãƒ‰
      const affectedIds = getAffectedLayerIds(prev, newState.currentIndex, prev.currentIndex);
      for (const id of affectedIds) {
        const e = findEntry(id);
        if (!e) continue;
        rebuildLayerFromHistory(e.committedLayer, newState);
        // ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æç”»æ™‚ã¯è‡ªå‹•çš„ã«å¯è¦–åŒ–
        if (!e.committedLayer.meta.visible) setLayerVisible(e.id, true);
      }
    }
    return newState;
  });
};

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ + pending ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç›´å¾Œã«æŒ¿å…¥
const renderLayers = useMemo(() => {
  const result: Layer[] = [];
  for (const entry of entries) {
    result.push(entry.committedLayer);
    if (entry.id === activeLayerId) {
      result.push(pendingLayer);
    }
  }
  return result;
}, [entries, activeLayerId, pendingLayer]);
```

### UIã‚¤ãƒ¡ãƒ¼ã‚¸

```
â”Œâ”€ SidebarPanel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Minimap                   â”‚  â† å…¨å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆè¡¨ç¤º
â”‚   [minimap canvas]          â”‚
â”‚                             â”‚
â”‚ â–¼ Layers (2)                â”‚
â”‚   [+ Add Layer]             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ â— Layer 2  ğŸ‘ â–² â–¼ ğŸ—‘ â”‚ â”‚  â† é¸æŠä¸­ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
â”‚   â”‚   Layer 1  ğŸ‘ â–² â–¼ ğŸ—‘ â”‚ â”‚
â”‚   â”‚   Background ğŸ‘       â”‚ â”‚  â† ç§»å‹•ãƒ»å‰Šé™¤ä¸å¯
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â”‚
â”‚ â–¼ History (5)               â”‚
â”‚   ...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºé †: ä¸Š=å‰é¢ã€ä¸‹=èƒŒé¢ï¼ˆé…åˆ—ã®é€†é †ã§è¡¨ç¤ºï¼‰

### å±¥æ­´ãƒ‘ãƒãƒ«è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

å…¨ã‚³ãƒãƒ³ãƒ‰ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼è­˜åˆ¥å­ã‚’ä»˜ä¸ã€‚ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®åº§æ¨™æ•°è¡¨ç¤ºã¯å‰Šé™¤ã€‚

```
 1. L1 Stroke                    æç”»ã‚³ãƒãƒ³ãƒ‰: "L{n} {æ“ä½œ}"
 2. L1 Eraser
 3. L2 Stroke           CP       å®šæœŸãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
 4.    + Layer 2                  æ§‹é€ ã‚³ãƒãƒ³ãƒ‰: å…ˆé ­ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼è­˜åˆ¥å­ãªã—
 5. L1 Clear
 6. L1 Offset
 7.    - Layer 1         CP  â—€   å‰Šé™¤æ™‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼ˆå¼·åˆ¶ä½œæˆï¼‰
 8.    â†• Layer 2
```

- **æç”»ã‚³ãƒãƒ³ãƒ‰**: `L{n} Stroke` / `L{n} Eraser` / `L{n} Clear` / `L{n} Offset`
- **æ§‹é€ ã‚³ãƒãƒ³ãƒ‰**: `+ Layer {n}` / `- Layer {n}` / `â†• Layer {n}`
- `{n}` ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤ºç•ªå·ï¼ˆä½œæˆé †ã§å›ºå®šã€ä¸¦ã¹æ›¿ãˆã§å¤‰ã‚ã‚‰ãªã„ï¼‰
- `remove-layer` ã«ã¯å¼·åˆ¶ä½œæˆã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã® CP è¡¨ç¤ºãŒã¤ã

---

## Phase 3: å®Ÿè£…

### Step 3-1: Engine ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

1. [types.ts](packages/engine/src/types.ts): `Layer` ã« `readonly id: string` è¿½åŠ 
2. [layer.ts](packages/engine/src/layer.ts): IDç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ã€`createLayer` æ›´æ–°
3. æ–°è¦ [layer-collection.ts](packages/engine/src/layer-collection.ts): ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
4. [index.ts](packages/engine/src/index.ts): æ–°è¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¿½åŠ 
5. ãƒ†ã‚¹ãƒˆæ›´æ–°ãƒ»è¿½åŠ :

   **Layer ID (`layer.test.ts` æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ )**:
   - `createLayer` ãŒ `id` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿”ã™
   - è¤‡æ•°å›ã® `createLayer` å‘¼ã³å‡ºã—ã§ä¸€æ„ãªIDãŒç”Ÿæˆã•ã‚Œã‚‹

   **ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ (`layer-collection.test.ts` æ–°è¦)**:
   - `addLayer`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ«å°¾ã«è¿½åŠ ã€`insertIndex` æŒ‡å®šã§ä»»æ„ä½ç½®ã«æŒ¿å…¥
   - `addLayer`: `[updatedLayers, newLayer]` ã‚’è¿”ã—ã€å…ƒã®é…åˆ—ã¯å¤‰æ›´ã—ãªã„
   - `removeLayer`: IDä¸€è‡´ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤ã€æ–°é…åˆ—ã‚’è¿”ã™
   - `removeLayer`: å­˜åœ¨ã—ãªã„IDã§å‘¼ã‚“ã å ´åˆã®æŒ™å‹•ï¼ˆå…ƒé…åˆ—ã‚’ãã®ã¾ã¾è¿”ã™ï¼‰
   - `findLayerById`: å­˜åœ¨ã™ã‚‹ID â†’ Layerè¿”å´ã€å­˜åœ¨ã—ãªã„ID â†’ `undefined`
   - `getLayerIndex`: æ­£ã—ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™ã€å­˜åœ¨ã—ãªã„IDã§ `-1`
   - `moveLayer`: `fromIndex â†’ toIndex` ã§æ­£ã—ãä¸¦ã¹æ›¿ãˆï¼ˆä»–ã®è¦ç´ ã®ç›¸å¯¾é †åºã‚’ç¶­æŒï¼‰
   - `moveLayer`: åŒä¸€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
   - `updateLayerMeta`: æŒ‡å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ›´æ–°ã—æ–°é…åˆ—ã‚’è¿”ã™ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼‰

6. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°:
   - [layer-api.md](packages/engine/docs/layer-api.md)
   - [README.md](packages/engine/docs/README.md)
   - æ–°è¦ `layer-collection-api.md`

### Step 3-2: Stroke ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

1. [types.ts](packages/stroke/src/types.ts):
   - æ—¢å­˜Commandå‹ã« `readonly layerId: string` è¿½åŠ 
   - æ–°è¦: `AddLayerCommand`, `RemoveLayerCommand`, `ReorderLayerCommand`
   - æ–°è¦: `DrawCommand`, `StructuralCommand` å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹
   - `Command` ã‚’ `DrawCommand | StructuralCommand` ã«å¤‰æ›´
   - æ–°è¦: `isDrawCommand()`, `isStructuralCommand()` å‹ã‚¬ãƒ¼ãƒ‰
   - `Checkpoint` ã« `readonly layerId: string` è¿½åŠ 
2. [checkpoint.ts](packages/stroke/src/checkpoint.ts): `createCheckpoint` ã« `layer.id` åæ˜ 
3. [history.ts](packages/stroke/src/history.ts):
   - `findBestCheckpoint` â†’ `findBestCheckpointForLayer(state, layerId)` ã«å¤‰æ›´
   - `getCommandsToReplay` â†’ `getCommandsToReplayForLayer(state, layerId, cp?)` ã«å¤‰æ›´
   - `computeCumulativeOffset` â†’ `computeCumulativeOffsetForLayer(state, layerId)` ã«å¤‰æ›´
   - æ–°è¦: `getAffectedLayerIds(state, fromIndex, toIndex)`
   - `pushCommand`: `layer` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã«ï¼ˆ`Layer | null`ï¼‰
   - `pushCommand`: `remove-layer` æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å¼·åˆ¶ä½œæˆ
   - `pushCommand`: `add-layer` / `reorder-layer` æ™‚ã¯ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆã—ãªã„
4. [replay.ts](packages/stroke/src/replay.ts):
   - `rebuildLayerState` â†’ `rebuildLayerFromHistory(layer, state)` ã«å¤‰æ›´ï¼ˆ`layer.id` ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
   - `replayCommand`: æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã¯ç„¡è¦–ï¼ˆ`isDrawCommand` ã‚¬ãƒ¼ãƒ‰ï¼‰
5. [session.ts](packages/stroke/src/session.ts):
   - æ—¢å­˜ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆé–¢æ•°ã« `layerId` è¿½åŠ 
   - æ–°è¦: `createAddLayerCommand()`, `createRemoveLayerCommand()`, `createReorderLayerCommand()`
6. [index.ts](packages/stroke/src/index.ts): æ–°è¦å‹ãƒ»é–¢æ•°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¿½åŠ 
7. ãƒ†ã‚¹ãƒˆæ›´æ–°ãƒ»è¿½åŠ :

   **å‹ã‚¬ãƒ¼ãƒ‰ (`types.test.ts` æ–°è¦)**:
   - `isDrawCommand`: stroke / clear / wrap-shift â†’ `true`
   - `isDrawCommand`: add-layer / remove-layer / reorder-layer â†’ `false`
   - `isStructuralCommand`: add-layer / remove-layer / reorder-layer â†’ `true`
   - `isStructuralCommand`: stroke / clear / wrap-shift â†’ `false`

   **ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ (`session.test.ts` æ—¢å­˜ã«è¿½åŠ )**:
   - `createStrokeCommand`: `layerId` ãŒç¬¬1å¼•æ•°ã¨ã—ã¦å«ã¾ã‚Œã‚‹
   - `createClearCommand`: `layerId` ãŒå«ã¾ã‚Œã‚‹
   - `createWrapShiftCommand`: `layerId` ãŒå«ã¾ã‚Œã‚‹
   - `createAddLayerCommand`: å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆlayerId, insertIndex, width, height, metaï¼‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹
   - `createRemoveLayerCommand`: layerId, removedIndex ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹
   - `createReorderLayerCommand`: layerId, fromIndex, toIndex ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹

   **pushCommand æ§‹é€ ã‚³ãƒãƒ³ãƒ‰å¯¾å¿œ (`history.test.ts` æ—¢å­˜ã«è¿½åŠ )**:
   - `remove-layer` ã‚’ push ã™ã‚‹ã¨ `checkpointInterval` ã«é–¢ä¿‚ãªããƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã‚‹
   - ä½œæˆã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã® `layerId` ãŒå‰Šé™¤å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®IDã¨ä¸€è‡´ã™ã‚‹
   - `add-layer` ã‚’ push ã—ã¦ã‚‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ä½œæˆã•ã‚Œãªã„ï¼ˆ`layer=null`ï¼‰
   - `reorder-layer` ã‚’ push ã—ã¦ã‚‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ä½œæˆã•ã‚Œãªã„
   - `remove-layer` ã®å¼·åˆ¶ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚‚ `maxCheckpoints` ã®æŠ¼ã—å‡ºã—ãƒ«ãƒ¼ãƒ«ã«å¾“ã†
   - Undoå¾Œã« `remove-layer` ã‚’ push ã—ãŸå ´åˆã€currentIndex ã‚ˆã‚Šå¾Œã®ã‚³ãƒãƒ³ãƒ‰ãƒ»ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã‚‹ï¼ˆæ—¢å­˜å‹•ä½œã®ç¶­æŒï¼‰

   **ãƒãƒ«ãƒãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´API (`history.test.ts` æ—¢å­˜ã«è¿½åŠ )**:
   - `findBestCheckpointForLayer`: å¯¾è±¡layerIdã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®ã¿è¿”ã™ï¼ˆä»–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚‚ã®ã‚’ç„¡è¦–ï¼‰
   - `findBestCheckpointForLayer`: currentIndexä»¥å‰ã§æœ€ã‚‚è¿‘ã„ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠ
   - `findBestCheckpointForLayer`: å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆ `undefined`
   - `getCommandsToReplayForLayer`: layerIdã§ãƒ•ã‚£ãƒ«ã‚¿ã—æç”»ã‚³ãƒãƒ³ãƒ‰ã®ã¿è¿”ã™ï¼ˆæ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã‚’é™¤å¤–ï¼‰
   - `getCommandsToReplayForLayer`: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä»¥é™ã€œcurrentIndexä»¥å†…ã®ç¯„å›²
   - `getAffectedLayerIds`: å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æç”»ã®ã¿ã®ç¯„å›² â†’ 1ã¤ã®layerId
   - `getAffectedLayerIds`: è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¾ãŸãŒã‚‹ç¯„å›² â†’ è¤‡æ•°ã®layerId
   - `getAffectedLayerIds`: æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã®ã¿ã®ç¯„å›² â†’ ç©ºã‚»ãƒƒãƒˆï¼ˆæç”»ã«å½±éŸ¿ã—ãªã„ï¼‰
   - `computeCumulativeOffsetForLayer`: å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã® wrap-shift ã®ã¿åˆç®—ã€ä»–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚‚ã®ã‚’ç„¡è¦–

   **ãƒªãƒ—ãƒ¬ã‚¤ (`replay.test.ts` æ—¢å­˜ã«è¿½åŠ )**:
   - `replayCommand`: æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã‚’æ¸¡ã—ã¦ã‚‚ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ”ã‚¯ã‚»ãƒ«ãŒå¤‰åŒ–ã—ãªã„ï¼ˆno-opï¼‰
   - `rebuildLayerFromHistory`: å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã®ã¿ãƒªãƒ—ãƒ¬ã‚¤ã—ã€ä»–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç„¡è¦–
   - `rebuildLayerFromHistory`: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€ãã“ã‹ã‚‰å¾©å…ƒ+å·®åˆ†ãƒªãƒ—ãƒ¬ã‚¤
   - `rebuildLayerFromHistory`: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒãªã„å ´åˆã€ã‚³ãƒãƒ³ãƒ‰0ã‹ã‚‰ãƒ•ãƒ«ãƒªãƒ—ãƒ¬ã‚¤

   **å‰Šé™¤Undoå¾©å…ƒã‚·ãƒŠãƒªã‚ª (`replay.test.ts` ã«è¿½åŠ )**:
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼Aã«æç”» â†’ `remove-layer` A â†’ undo: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å¾©å…ƒã•ã‚Œæç”»å†…å®¹ãŒä¸€è‡´ã™ã‚‹
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼Aã«æç”» â†’ `remove-layer` A â†’ ä»–ã®æ“ä½œã‚’ `maxCheckpoints` å›ä»¥ä¸Š â†’ undo: ãƒ•ãƒ«ãƒªãƒ—ãƒ¬ã‚¤ã§æ­£ã—ãå¾©å…ƒã•ã‚Œã‚‹

8. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°:
   - [types.md](packages/stroke/docs/types.md)
   - [history-api.md](packages/stroke/docs/history-api.md)
   - [session-api.md](packages/stroke/docs/session-api.md)
   - [README.md](packages/stroke/docs/README.md)

### Step 3-3: Web App

1. æ–°è¦ [hooks/useLayers.ts](apps/web/src/hooks/useLayers.ts):
   - çŠ¶æ…‹: `entries: LayerEntry[]`, `activeLayerId: string | null`
   - `entriesRef` ã§æœ€æ–°entriesã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰å‚ç…§
   - åˆæœŸçŠ¶æ…‹: 1ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆã€ãã®IDã‚’activeã«
   - `addLayer`: æ–°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æœ€ä¸Šä½ã«è¿½åŠ ã€è‡ªå‹•é¸æŠã€‚**å†…éƒ¨æ“ä½œã®ã¿ï¼ˆã‚³ãƒãƒ³ãƒ‰ã¯å‘¼ã³å‡ºã—å´ã§ç™ºè¡Œï¼‰**
   - `removeLayer`: å‰Šé™¤å¾Œã€éš£æ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è‡ªå‹•é¸æŠï¼ˆ0æšã‚‚è¨±å®¹ï¼‰ã€‚**å†…éƒ¨æ“ä½œã®ã¿**
   - `reinsertLayer(layerId, index)`: Undoæ™‚ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å†æŒ¿å…¥
   - `toggleVisibility`: `layer.meta.visible` ã‚’ç›´æ¥ãƒˆã‚°ãƒ« + renderVersionæ›´æ–°ï¼ˆå±¥æ­´å¯¾è±¡å¤–ï¼‰
   - `setLayerVisible(layerId, visible)`: ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®Undo/Redoæç”»æ™‚ã®è‡ªå‹•å¯è¦–åŒ–ç”¨
   - `moveLayerUp/Down`: é…åˆ—å†…ã®ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆã€‚**å†…éƒ¨æ“ä½œã®ã¿**
2. æ–°è¦ [components/LayerPanel.tsx](apps/web/src/components/LayerPanel.tsx):
   - èƒŒæ™¯è¡Œï¼ˆå¸¸ã«æœ€ä¸‹æ®µã€ç§»å‹•ãƒ»å‰Šé™¤ä¸å¯ã€å¯è¦–ãƒˆã‚°ãƒ«ã®ã¿ï¼‰
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œï¼ˆä¸Š=å‰é¢é †ã«è¡¨ç¤ºã€é¸æŠãƒ»å¯è¦–ãƒˆã‚°ãƒ«ãƒ»ä¸Šä¸‹ç§»å‹•ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
   - è¿½åŠ ãƒœã‚¿ãƒ³
3. [components/SidebarPanel.tsx](apps/web/src/components/SidebarPanel.tsx):
   - propså¤‰æ›´: `layer: Layer` â†’ `layers: readonly Layer[]` + ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ç”¨propsè¿½åŠ 
   - Minimap ã¨ History ã®é–“ã« Layers AccordionPanel è¿½åŠ 
4. [components/Minimap.tsx](apps/web/src/components/Minimap.tsx):
   - `layer: Layer` â†’ `layers: readonly Layer[]` ã«å¤‰æ›´
   - `renderLayerWithTransform` â†’ `renderLayers` ã«å¤‰æ›´ï¼ˆå…¨å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆè¡¨ç¤ºï¼‰
5. [App.tsx](apps/web/src/App.tsx) ä¸»è¦å¤‰æ›´:
   - `committedLayer` useMemo â†’ `useLayers` hook ã«ç½®ãæ›ãˆ
   - `pendingLayer` ã¯ãã®ã¾ã¾å…±æœ‰
   - `canDraw` åˆ¤å®šè¿½åŠ 
   - `onStrokeStart/Move/End`: `activeEntry.committedLayer` ã‚’ä½¿ç”¨ã€`canDraw` ã‚¬ãƒ¼ãƒ‰
   - `onStrokeEnd`: `createStrokeCommand(activeLayerId!, ...)` ã«å¤‰æ›´
   - `handleWrapShift/End`: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾è±¡
   - `handleAddLayer/RemoveLayer/MoveLayer`: æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã‚’å±¥æ­´ã«è¨˜éŒ²
   - `handleUndo/Redo`: `isStructuralCommand` ã§åˆ†å²ã€‚æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã€æç”»ã‚³ãƒãƒ³ãƒ‰ã¯å½±éŸ¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ãƒªãƒ“ãƒ«ãƒ‰ + ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªå‹•å¯è¦–åŒ–
   - `handleResetOffset`: `computeCumulativeOffsetForLayer(state, activeLayerId)` ã«å¤‰æ›´
   - `layers` é…åˆ—æ§‹ç¯‰: å…¨committed + pending ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç›´å¾Œã«æŒ¿å…¥
   - `SidebarPanel` propsã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œã«æ›´æ–°
   - `wrapOffset` è¡¨ç¤º: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®offsetã‚’è¡¨ç¤º
6. [components/HistoryContent.tsx](apps/web/src/components/HistoryContent.tsx):
   - `getCommandLabel` æ›´æ–°: åº§æ¨™æ•°è¡¨ç¤ºã‚’å‰Šé™¤ã€å…¨ã‚³ãƒãƒ³ãƒ‰ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼è­˜åˆ¥å­ã‚’ä»˜ä¸
   - æç”»ã‚³ãƒãƒ³ãƒ‰: `L{n} Stroke` / `L{n} Eraser` / `L{n} Clear` / `L{n} Offset`
   - æ§‹é€ ã‚³ãƒãƒ³ãƒ‰: `+ Layer {n}` / `- Layer {n}` / `â†• Layer {n}`
   - `getCommandLabel` ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼åè§£æ±ºé–¢æ•°ã‚’è¿½åŠ ï¼ˆ`layerId â†’ è¡¨ç¤ºå`ï¼‰
   - `remove-layer` ã®å¼·åˆ¶ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒ CP è¡¨ç¤ºã«åæ˜ ã•ã‚Œã‚‹ï¼ˆæ—¢å­˜ã® `hasCheckpoint` ãƒ­ã‚¸ãƒƒã‚¯ã§å¯¾å¿œï¼‰

---

## Phase 4: æ¤œè¨¼

### 4-1. è‡ªå‹•ãƒ†ã‚¹ãƒˆ

1. `pnpm --filter @headless-paint/engine test` â€” å…¨ãƒ†ã‚¹ãƒˆé€šé
2. `pnpm --filter @headless-paint/stroke test` â€” å…¨ãƒ†ã‚¹ãƒˆé€šé
3. `pnpm build` â€” å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰æˆåŠŸ
4. `pnpm lint` â€” linté€šé

### 4-2. æ‰‹å‹•æ¤œè¨¼ (`pnpm dev`)

**ãƒ¬ã‚¤ãƒ¤ãƒ¼åŸºæœ¬æ“ä½œ**:
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ã§æ–°ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæœ€ä¸Šä½ã«è¿½åŠ ã•ã‚Œè‡ªå‹•é¸æŠã•ã‚Œã‚‹
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¶ˆãˆã€éš£æ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè‡ªå‹•é¸æŠã•ã‚Œã‚‹
- [ ] å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ã§0æšçŠ¶æ…‹ã«ãªã‚Šæç”»ä¸å¯ã«ãªã‚‹
- [ ] â–²â–¼ãƒœã‚¿ãƒ³ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æç”»é †ãŒå¤‰ã‚ã‚‹ï¼ˆå‰é¢/èƒŒé¢ã®ç§»å‹•ãŒè¦–è¦šçš„ã«ç¢ºèªã§ãã‚‹ï¼‰
- [ ] å¯è¦–åˆ‡æ›¿ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
- [ ] ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ãŸçŠ¶æ…‹ã§ã¯æç”»æ“ä½œãŒç„¡è¦–ã•ã‚Œã‚‹

**ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥æç”»**:
- [ ] L1ã«èµ¤ã§æç”» â†’ L2ã«é’ã§æç”» â†’ å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å†…å®¹ãŒç‹¬ç«‹ã—ã¦ã„ã‚‹
- [ ] æ¶ˆã—ã‚´ãƒ ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã«é©ç”¨ã•ã‚Œã‚‹ï¼ˆä»–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å½±éŸ¿ã—ãªã„ï¼‰
- [ ] å¯¾ç§°æç”»ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸Šã§æ­£ã—ãå±•é–‹ã•ã‚Œã‚‹
- [ ] WrapShiftãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã«é©ç”¨ã•ã‚Œã‚‹

**æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã®Undo/Redo**:
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ  â†’ Undo â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¶ˆãˆã‚‹ â†’ Redo â†’ ç©ºã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå†ä½œæˆã•ã‚Œã‚‹
- [ ] L1ã«æç”» â†’ L1ã‚’å‰Šé™¤ â†’ Undo â†’ L1ãŒæç”»å†…å®¹ã”ã¨å¾©å…ƒã•ã‚Œã‚‹ â†’ Redo â†’ å†ã³å‰Šé™¤ã•ã‚Œã‚‹
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸¦ã¹æ›¿ãˆ â†’ Undo â†’ å…ƒã®é †åºã«æˆ»ã‚‹ â†’ Redo â†’ å†ã³ä¸¦ã¹æ›¿ãˆã‚‰ã‚Œã‚‹
- [ ] L1ã«æç”» â†’ L2ã«æç”» â†’ L1ã‚’å‰Šé™¤ â†’ Undo â†’ L1ãŒå†…å®¹ã”ã¨å¾©å…ƒã•ã‚Œã‚‹ï¼ˆL2ã®å†…å®¹ã«å½±éŸ¿ã—ãªã„ï¼‰

**æç”»ã‚³ãƒãƒ³ãƒ‰ã¨æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ã®æ··åœ¨**:
- [ ] L1æç”» â†’ L2è¿½åŠ  â†’ L2æç”» â†’ UndoÃ—3 â†’ å…¨æ“ä½œãŒæ­£ã—ãå·»ãæˆ»ã‚‹ â†’ RedoÃ—3 â†’ å…¨æ“ä½œãŒæ­£ã—ãã‚„ã‚Šç›´ã•ã‚Œã‚‹
- [ ] L1æç”» â†’ L2è¿½åŠ  â†’ L2æç”» â†’ UndoÃ—2 â†’ L1ã«æ–°è¦æç”» â†’ L2è¿½åŠ ã¨L2æç”»ã®Redoä¸å¯ã«ãªã‚‹

**ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªå‹•å¯è¦–åŒ–**:
- [ ] L1ã«æç”» â†’ L1ã‚’ä¸å¯è¦–ã« â†’ Undoï¼ˆæç”»ã®Undoï¼‰â†’ L1ãŒè‡ªå‹•çš„ã«å¯è¦–ã«ãªã‚‹

**å±¥æ­´ãƒ‘ãƒãƒ«è¡¨ç¤º**:
- [ ] æç”»ã‚³ãƒãƒ³ãƒ‰ã« `L{n}` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆä¾‹: `L1 Stroke`, `L2 Eraser`ï¼‰
- [ ] åº§æ¨™æ•°ï¼ˆptsï¼‰ãŒè¡¨ç¤ºã•ã‚Œãªã„
- [ ] æ§‹é€ ã‚³ãƒãƒ³ãƒ‰ãŒ `+ Layer {n}` / `- Layer {n}` / `â†• Layer {n}` ã§è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã« CP è¡¨ç¤ºãŒã¤ã
- [ ] ç¾åœ¨ä½ç½®ã® â—€ ãƒãƒ¼ã‚«ãƒ¼ãŒæ­£ã—ãç§»å‹•ã™ã‚‹

**Minimap**:
- [ ] å…¨å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæˆçµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¯è¦–åˆ‡æ›¿ãŒMinimapã«å³åæ˜ ã•ã‚Œã‚‹

### 4-3. ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼

review-library-usage ã‚¹ã‚­ãƒ«ã§ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼
