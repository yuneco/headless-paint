# ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½ã®è¿½åŠ 

> ä¿å­˜å…ˆ: `/plans/2026-02-08-04-50_layer-feature.md`

## Context

ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã¯ committed + pending ã®2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã§å‹•ä½œã—ã¦ã„ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§æç”»ã§ãã‚‹ã‚ˆã†ã«ã—ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã¹æ›¿ãˆãƒ»å¯è¦–åˆ‡æ›¿ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€‚ã‚¨ãƒ³ã‚¸ãƒ³è‡ªä½“ã¯æ—¢ã« `renderLayers` ã«ã‚ˆã‚‹è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãŒã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«IDãŒãªãã€å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã‚‚å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰æã€‚

### æ±ºå®šæ¸ˆã¿ä»•æ§˜

- **Undo/Redo**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆå…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¨ªæ–­ã®1æœ¬ã®å±¥æ­´ï¼‰
- **èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼**: æç”»ä¸å¯ã€‚BackgroundSettingsã®ã¾ã¾ãƒ‘ãƒãƒ«è¡¨ç¤ºï¼ˆè‰²å¤‰æ›´ãƒ»è¡¨ç¤ºåˆ‡æ›¿ã®ã¿ï¼‰
- **æ“ä½œã‚¹ã‚³ãƒ¼ãƒ—**: è¿½åŠ ãƒ»å‰Šé™¤ãƒ»å¯è¦–åˆ‡æ›¿ãƒ»ä¸¦ã¹æ›¿ãˆï¼ˆãƒœã‚¿ãƒ³å¼ï¼‰ã®ã¿ã€‚opacity/blend/rename/mergeã¯å¾Œå›ã—
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼0æš**: è¨±å®¹ï¼ˆèƒŒæ™¯ã®ã¿çŠ¶æ…‹ã€‚æç”»ä¸å¯ï¼‰
- **ãƒšãƒ³/å¯¾ç§°/å±¥æ­´è¨­å®š**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥è¨­å®šãªã—ï¼‰

---

## Phase 1: APIè¨­è¨ˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

### 1-1. Engine: `Layer` ã« `id` è¿½åŠ 

**[types.ts](packages/engine/src/types.ts)**

```typescript
export interface Layer {
  readonly id: string;        // NEW
  readonly width: number;
  readonly height: number;
  readonly canvas: OffscreenCanvas;
  readonly ctx: OffscreenCanvasRenderingContext2D;
  readonly meta: LayerMeta;
}
```

**[layer.ts](packages/engine/src/layer.ts)**: `createLayer` ã§IDè‡ªå‹•ç”Ÿæˆ

```typescript
let layerIdCounter = 0;
function generateLayerId(): string {
  return `layer_${Date.now()}_${++layerIdCounter}`;
}
```

### 1-2. Engine: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒ«ãƒ‘ãƒ¼

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: [layer-collection.ts](packages/engine/src/layer-collection.ts)**

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯ `readonly Layer[]` ã®ã¾ã¾ã€‚ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤:

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `addLayer(layers, width, height, meta?, insertIndex?)` | `[updatedLayers, newLayer]` ã‚’è¿”ã™ |
| `removeLayer(layers, layerId)` | IDæŒ‡å®šã§å‰Šé™¤ |
| `findLayerById(layers, layerId)` | IDæ¤œç´¢ |
| `getLayerIndex(layers, layerId)` | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å–å¾— |
| `moveLayer(layers, fromIndex, toIndex)` | ä¸¦ã¹æ›¿ãˆ |
| `updateLayerMeta(layers, layerId, metaUpdate)` | metaæ›´æ–°ï¼ˆæ–°é…åˆ—ã‚’è¿”ã™ï¼‰ |

### 1-3. Stroke: Command ã« `layerId` è¿½åŠ 

**[types.ts](packages/stroke/src/types.ts)**

å…¨Commandå‹ã« `readonly layerId: string` ã‚’è¿½åŠ :

```typescript
export interface StrokeCommand {
  readonly type: "stroke";
  readonly layerId: string;    // NEW
  // ...æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}
export interface ClearCommand {
  readonly type: "clear";
  readonly layerId: string;    // NEW
  readonly timestamp: number;
}
export interface WrapShiftCommand {
  readonly type: "wrap-shift";
  readonly layerId: string;    // NEW
  // ...æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}
```

`Checkpoint` ã«ã‚‚ `layerId` è¿½åŠ :

```typescript
export interface Checkpoint {
  readonly id: string;
  readonly layerId: string;    // NEW
  readonly commandIndex: number;
  readonly imageData: ImageData;
  readonly createdAt: number;
}
```

`HistoryState` ã®å‹è‡ªä½“ã¯å¤‰æ›´ãªã—ï¼ˆcommands/checkpointsãŒå†…éƒ¨çš„ã«layerIdã‚’æŒã¤ï¼‰ã€‚

### 1-4. Stroke: ãƒãƒ«ãƒãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´API

**[history.ts](packages/stroke/src/history.ts)** ã«è¿½åŠ :

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `findBestCheckpointForLayer(state, layerId)` | ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€é©checkpoint |
| `getCommandsToReplayForLayer(state, layerId, checkpoint?)` | ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªãƒ—ãƒ¬ã‚¤å¯¾è±¡ã‚³ãƒãƒ³ãƒ‰ |
| `getAffectedLayerIds(state, fromIndex, toIndex)` | 2ã¤ã®indexé–“ã§å½±éŸ¿ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚»ãƒƒãƒˆ |
| `computeCumulativeOffsetForLayer(state, layerId)` | ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®wrap-shiftç´¯ç© |

**[replay.ts](packages/stroke/src/replay.ts)** ã«è¿½åŠ :

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `rebuildLayerFromHistory(layer, state)` | `layer.id` ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ãƒªãƒ“ãƒ«ãƒ‰ |

æ—¢å­˜ã® `rebuildLayerState` / `findBestCheckpoint` / `computeCumulativeOffset` ã¯å‰Šé™¤ï¼ˆç ´å£Šçš„å¤‰æ›´OKï¼‰ã€‚

### 1-5. Stroke: ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆé–¢æ•°ã®å¤‰æ›´

å…¨ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆé–¢æ•°ã«ç¬¬1å¼•æ•° `layerId: string` ã‚’è¿½åŠ :

```typescript
createStrokeCommand(layerId, inputPoints, filterPipeline, expand, ...)
createClearCommand(layerId)
createWrapShiftCommand(layerId, dx, dy)
endStrokeSession(state, layerId, inputPoints, filterPipeline)
```

### 1-6. `pushCommand` ã®å‹•ä½œ

`pushCommand(state, command, layer, config)` ã®ã‚·ã‚°ãƒãƒãƒ£ã¯å¤‰æ›´ãªã—ã€‚
- `layer` ã¯ `command.layerId` ã«å¯¾å¿œã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆcheckpointä½œæˆç”¨ï¼‰
- `createCheckpoint` ãŒ `layer.id` ã‚’checkpointã«è¨˜éŒ²

### 1-7. å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚³ãƒãƒ³ãƒ‰

å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚³ãƒãƒ³ãƒ‰ã¯å±¥æ­´ã«æ®‹ã‚‹ã€‚Undo/Redoæ™‚ã« `getAffectedLayerIds` ãŒè¿”ã™IDã«å¯¾å¿œã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°ã€ã‚¹ã‚­ãƒƒãƒ—ã€‚ç‰¹åˆ¥ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯ä¸è¦ã€‚

---

## Phase 2: åˆ©ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ãƒ“ãƒ¥ãƒ¼

### Web App ã§ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ•ãƒ­ãƒ¼

```typescript
// --- useLayers hook ---
const {
  entries,          // readonly LayerEntry[] (id + committedLayer)
  activeLayerId,    // string | null
  activeEntry,      // LayerEntry | undefined (derived)
  addLayer, removeLayer, setActiveLayerId,
  toggleVisibility, moveLayerUp, moveLayerDown,
} = useLayers(LAYER_WIDTH, LAYER_HEIGHT);

// å…±æœ‰ pending layer
const pendingLayer = useMemo(() => createLayer(W, H), []);

// æç”»å¯å¦åˆ¤å®š
const canDraw = activeEntry != null && activeEntry.committedLayer.meta.visible;

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹æ™‚
const onStrokeStart = (point: InputPoint) => {
  if (!canDraw) return;
  // ...filter, session é–‹å§‹
  appendToCommittedLayer(activeEntry.committedLayer, ..., strokeStyle, compiled);
  renderPendingLayer(pendingLayer, ..., strokeStyle, compiled);
};

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ‚äº†æ™‚
const onStrokeEnd = () => {
  // ...
  const command = createStrokeCommand(
    activeLayerId!,  // layerId (ç¬¬1å¼•æ•°)
    inputPoints, filterPipeline.config, expand, ...
  );
  setHistoryState(prev =>
    pushCommand(prev, command, activeEntry!.committedLayer, HISTORY_CONFIG)
  );
};

// Undo
const handleUndo = () => {
  setHistoryState(prev => {
    if (!canUndo(prev)) return prev;
    const oldIndex = prev.currentIndex;
    const newState = undo(prev);
    // å½±éŸ¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ãƒªãƒ“ãƒ«ãƒ‰
    const affectedIds = getAffectedLayerIds(prev, newState.currentIndex, oldIndex);
    for (const id of affectedIds) {
      const entry = entriesRef.current.find(e => e.id === id);
      if (entry) rebuildLayerFromHistory(entry.committedLayer, newState);
    }
    return newState;
  });
};

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ + pending ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç›´å¾Œã«æŒ¿å…¥
const renderLayers = useMemo(() => {
  const result: Layer[] = [];
  for (const entry of entries) {
    result.push(entry.committedLayer);
    if (entry.id === activeLayerId) {
      result.push(pendingLayer);
    }
  }
  return result;
}, [entries, activeLayerId, pendingLayer]);
```

### UIã‚¤ãƒ¡ãƒ¼ã‚¸

```
â”Œâ”€ SidebarPanel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Minimap                   â”‚  â† å…¨å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆè¡¨ç¤º
â”‚   [minimap canvas]          â”‚
â”‚                             â”‚
â”‚ â–¼ Layers (2)                â”‚
â”‚   [+ Add Layer]             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ â— Layer 2  ğŸ‘ â–² â–¼ ğŸ—‘ â”‚ â”‚  â† é¸æŠä¸­ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
â”‚   â”‚   Layer 1  ğŸ‘ â–² â–¼ ğŸ—‘ â”‚ â”‚
â”‚   â”‚   Background ğŸ‘       â”‚ â”‚  â† ç§»å‹•ãƒ»å‰Šé™¤ä¸å¯
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â”‚
â”‚ â–¼ History (5)               â”‚
â”‚   ...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºé †: ä¸Š=å‰é¢ã€ä¸‹=èƒŒé¢ï¼ˆé…åˆ—ã®é€†é †ã§è¡¨ç¤ºï¼‰

---

## Phase 3: å®Ÿè£…

### Step 3-1: Engine ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

1. [types.ts](packages/engine/src/types.ts): `Layer` ã« `readonly id: string` è¿½åŠ 
2. [layer.ts](packages/engine/src/layer.ts): IDç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ã€`createLayer` æ›´æ–°
3. æ–°è¦ [layer-collection.ts](packages/engine/src/layer-collection.ts): ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
4. [index.ts](packages/engine/src/index.ts): æ–°è¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¿½åŠ 
5. ãƒ†ã‚¹ãƒˆæ›´æ–°ãƒ»è¿½åŠ 
6. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°:
   - [layer-api.md](packages/engine/docs/layer-api.md)
   - [README.md](packages/engine/docs/README.md)
   - æ–°è¦ `layer-collection-api.md`

### Step 3-2: Stroke ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

1. [types.ts](packages/stroke/src/types.ts): å…¨Command + Checkpoint ã« `layerId` è¿½åŠ 
2. [checkpoint.ts](packages/stroke/src/checkpoint.ts): `createCheckpoint` ã« `layer.id` åæ˜ 
3. [history.ts](packages/stroke/src/history.ts):
   - `findBestCheckpoint` â†’ `findBestCheckpointForLayer(state, layerId)` ã«å¤‰æ›´
   - `getCommandsToReplay` â†’ `getCommandsToReplayForLayer(state, layerId, cp?)` ã«å¤‰æ›´
   - `computeCumulativeOffset` â†’ `computeCumulativeOffsetForLayer(state, layerId)` ã«å¤‰æ›´
   - æ–°è¦: `getAffectedLayerIds(state, fromIndex, toIndex)`
4. [replay.ts](packages/stroke/src/replay.ts):
   - `rebuildLayerState` â†’ `rebuildLayerFromHistory(layer, state)` ã«å¤‰æ›´ï¼ˆ`layer.id` ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
5. [session.ts](packages/stroke/src/session.ts): ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆé–¢æ•°ã« `layerId` è¿½åŠ 
6. [index.ts](packages/stroke/src/index.ts): ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ›´æ–°
7. ãƒ†ã‚¹ãƒˆæ›´æ–°ãƒ»è¿½åŠ 
8. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°:
   - [types.md](packages/stroke/docs/types.md)
   - [history-api.md](packages/stroke/docs/history-api.md)
   - [session-api.md](packages/stroke/docs/session-api.md)
   - [README.md](packages/stroke/docs/README.md)

### Step 3-3: Web App

1. æ–°è¦ [hooks/useLayers.ts](apps/web/src/hooks/useLayers.ts):
   - çŠ¶æ…‹: `entries: LayerEntry[]`, `activeLayerId: string | null`
   - `entriesRef` ã§æœ€æ–°entriesã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰å‚ç…§
   - åˆæœŸçŠ¶æ…‹: 1ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆã€ãã®IDã‚’activeã«
   - `addLayer`: æ–°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æœ€ä¸Šä½ã«è¿½åŠ ã€è‡ªå‹•é¸æŠ
   - `removeLayer`: å‰Šé™¤å¾Œã€éš£æ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è‡ªå‹•é¸æŠï¼ˆ0æšã‚‚è¨±å®¹ï¼‰
   - `toggleVisibility`: `layer.meta.visible` ã‚’ç›´æ¥ãƒˆã‚°ãƒ« + renderVersionæ›´æ–°
   - `moveLayerUp/Down`: é…åˆ—å†…ã®ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆ
2. æ–°è¦ [components/LayerPanel.tsx](apps/web/src/components/LayerPanel.tsx):
   - èƒŒæ™¯è¡Œï¼ˆå¸¸ã«æœ€ä¸‹æ®µã€ç§»å‹•ãƒ»å‰Šé™¤ä¸å¯ã€å¯è¦–ãƒˆã‚°ãƒ«ã®ã¿ï¼‰
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œï¼ˆä¸Š=å‰é¢é †ã«è¡¨ç¤ºã€é¸æŠãƒ»å¯è¦–ãƒˆã‚°ãƒ«ãƒ»ä¸Šä¸‹ç§»å‹•ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
   - è¿½åŠ ãƒœã‚¿ãƒ³
3. [components/SidebarPanel.tsx](apps/web/src/components/SidebarPanel.tsx):
   - propså¤‰æ›´: `layer: Layer` â†’ `layers: readonly Layer[]` + ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ç”¨propsè¿½åŠ 
   - Minimap ã¨ History ã®é–“ã« Layers AccordionPanel è¿½åŠ 
4. [components/Minimap.tsx](apps/web/src/components/Minimap.tsx):
   - `layer: Layer` â†’ `layers: readonly Layer[]` ã«å¤‰æ›´
   - `renderLayerWithTransform` â†’ `renderLayers` ã«å¤‰æ›´ï¼ˆå…¨å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆè¡¨ç¤ºï¼‰
5. [App.tsx](apps/web/src/App.tsx) ä¸»è¦å¤‰æ›´:
   - `committedLayer` useMemo â†’ `useLayers` hook ã«ç½®ãæ›ãˆ
   - `pendingLayer` ã¯ãã®ã¾ã¾å…±æœ‰
   - `canDraw` åˆ¤å®šè¿½åŠ 
   - `onStrokeStart/Move/End`: `activeEntry.committedLayer` ã‚’ä½¿ç”¨ã€`canDraw` ã‚¬ãƒ¼ãƒ‰
   - `onStrokeEnd`: `createStrokeCommand(activeLayerId!, ...)` ã«å¤‰æ›´
   - `handleWrapShift/End`: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾è±¡
   - `handleUndo/Redo`: `getAffectedLayerIds` â†’ å½±éŸ¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ãƒªãƒ“ãƒ«ãƒ‰
   - `handleResetOffset`: `computeCumulativeOffsetForLayer(state, activeLayerId)` ã«å¤‰æ›´
   - `layers` é…åˆ—æ§‹ç¯‰: å…¨committed + pending ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç›´å¾Œã«æŒ¿å…¥
   - `SidebarPanel` propsã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œã«æ›´æ–°
   - `wrapOffset` è¡¨ç¤º: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®offsetã‚’è¡¨ç¤º
6. [components/HistoryContent.tsx](apps/web/src/components/HistoryContent.tsx):
   - ã‚³ãƒãƒ³ãƒ‰ãƒ©ãƒ™ãƒ«ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’è¡¨ç¤ºï¼ˆ`[Layer 1] Stroke (42 pts)`ï¼‰

---

## Phase 4: æ¤œè¨¼

1. `pnpm --filter @headless-paint/engine test` â€” å…¨ãƒ†ã‚¹ãƒˆé€šé
2. `pnpm --filter @headless-paint/stroke test` â€” å…¨ãƒ†ã‚¹ãƒˆé€šé
3. `pnpm build` â€” å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰æˆåŠŸ
4. `pnpm lint` â€” linté€šé
5. `pnpm dev` ã§æ‰‹å‹•æ¤œè¨¼:
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã¹æ›¿ãˆãƒ»å¯è¦–åˆ‡æ›¿
   - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æç”»
   - ä¸å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠæ™‚ã«æç”»ä¸å¯
   - 0ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã§æç”»ä¸å¯
   - Undo/RedoãŒãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã¾ãŸã„ã§æ­£ã—ãå‹•ä½œ
   - Minimapã«å…¨å¯è¦–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¡¨ç¤º
   - å±¥æ­´è¡¨ç¤ºã«ãƒ¬ã‚¤ãƒ¤ãƒ¼åãŒåæ˜ 
   - æ¶ˆã—ã‚´ãƒ ãƒ»å¯¾ç§°æç”»ãŒãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œã§æ­£å¸¸å‹•ä½œ
   - WrapShiftãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã«é©ç”¨
6. review-library-usage ã‚¹ã‚­ãƒ«ã§ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼
