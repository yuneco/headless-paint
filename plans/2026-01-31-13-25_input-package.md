# inputパッケージ実装計画

## 座標系の定義

| 日本語 | 英語 | 説明 |
|--------|------|------|
| スクリーン座標系 | Screen Space | 出力先Canvas要素内の座標。入出力の共通座標系 |
| 論理座標系 | Layer Space | レイヤー固有座標。ストローク記録先 |
| ビュー変換 | View Transform | Layer Space ↔ Screen Space の変換行列 |

※ DOM上のCanvas配置位置はアプリケーションの責任。inputパッケージは関知しない。

## 座標変換フロー

```
【入力】Screen Space → Layer Space (逆ビュー変換)
【描画】Layer Space → Screen Space (正ビュー変換)
```

---

## Retina対応

アプリ層で `ctx.scale(dpr, dpr)` を使う前提。これにより：
- `offsetX/Y` をそのままScreen Spaceとして使える
- Layer Spaceも論理ピクセルベースで統一

```typescript
// アプリ層での初期化例
const dpr = window.devicePixelRatio;
canvas.width = logicalWidth * dpr;
canvas.height = logicalHeight * dpr;
canvas.style.width = `${logicalWidth}px`;
canvas.style.height = `${logicalHeight}px`;
ctx.scale(dpr, dpr);
```

---

## 実装内容

### Phase 1: inputパッケージ基盤

**ファイル構成:**
```
packages/input/src/
├── types.ts        # ViewTransform, Point, SamplingConfig等
├── transform.ts    # pan/zoom/rotate関数（gl-matrix使用）
├── coordinate.ts   # screenToLayer等の座標変換
├── sampling.ts     # 入力座標の間引き
└── index.ts
```

**主要API:**

```typescript
// ビュー変換
createViewTransform(): ViewTransform
pan(transform, dx, dy): ViewTransform
zoom(transform, scale, centerX, centerY): ViewTransform
rotate(transform, angleRad, centerX, centerY): ViewTransform
invertViewTransform(transform): ViewTransform | null

// 座標変換
screenToLayer(screenPoint, transform): Point | null
layerToScreen(layerPoint, transform): Point

// 間引き
shouldAcceptPoint(point, timestamp, state, config): [boolean, SamplingState]
```

### Phase 2: engineパッケージ拡張

**新規ファイル:** `render.ts`
- `renderLayerWithTransform(layer, ctx, transform)` - 変換適用描画
- `renderLayers(layers, ctx, transform)` - 複数レイヤー合成

### Phase 3: デモアプリ基本機能

**新規hooks:**
- `useViewTransform` - ビュー変換状態管理
- `usePointerHandler` - ポインター入力 + 間引き処理

**Canvas更新:** ViewTransform対応、ドラッグ描画

### Phase 4: デモアプリUI

**新規コンポーネント:**
- `Toolbar.tsx` - ペン/スクロール/回転/ズーム切替
- `Minimap.tsx` - 右上の全体ビュー（赤枠で表示範囲）
- `DebugPanel.tsx` - lil-guiで座標系情報表示・設定

---

## アプリ層からの利用方法

### 1. 初期化

```typescript
import { createViewTransform } from "@headless-paint/input";
import { createLayer } from "@headless-paint/engine";

const layer = createLayer(1920, 1080);
let viewTransform = createViewTransform(); // 単位行列
```

### 2. PointerEvent処理

```typescript
import { screenToLayer, shouldAcceptPoint } from "@headless-paint/input";

function onPointerMove(e: PointerEvent) {
  // offsetX/Yを使用（DOM配置位置は関係ない）
  const screenPoint = { x: e.offsetX, y: e.offsetY };

  // Screen Space → Layer Space
  const layerPoint = screenToLayer(screenPoint, viewTransform);
  if (!layerPoint) return;

  // 間引き判定（Layer Spaceで評価）
  const [accepted, newState] = shouldAcceptPoint(
    layerPoint, e.timeStamp, samplingState, { minDistance: 2 }
  );
  if (accepted) {
    // ストローク記録・描画
  }
}
```

### 3. ビュー操作

```typescript
import { pan, zoom, rotate } from "@headless-paint/input";

// スクロール（Screen Spaceでの移動量）
viewTransform = pan(viewTransform, deltaX, deltaY);

// ズーム（Screen Space中心基準）
const cx = canvasWidth / 2;
const cy = canvasHeight / 2;
viewTransform = zoom(viewTransform, 1.1, cx, cy);

// 回転（Screen Space中心基準）
viewTransform = rotate(viewTransform, Math.PI / 12, cx, cy);
```

### 4. 描画

```typescript
import { renderLayerWithTransform } from "@headless-paint/engine";

// メインビュー
renderLayerWithTransform(layer, mainCtx, viewTransform);

// 全体ビュー（別のビュー変換）
const minimapTransform = createMinimapTransform(layer, minimapSize);
renderLayerWithTransform(layer, minimapCtx, minimapTransform);
```

---

## ツール操作仕様

| ツール | 操作 |
|--------|------|
| ペン | ドラッグでストローク描画 |
| スクロール | ドラッグ方向に移動（回転考慮） |
| 回転 | 水平ドラッグでビュー中心基準回転 |
| ズーム | 垂直ドラッグでビュー中心基準ズーム |

---

## デバッグUIライブラリ

**lil-gui** を採用
- dat.guiの後継、TypeScript対応、軽量（~10KB）

## 全体ビュー（Minimap）

- サイズ: 200x150px程度
- 位置: 右上固定
- 赤枠でメインビューの表示範囲を表示

---

## 検証方法

1. `pnpm test` - ユニットテスト実行
2. `pnpm -F @headless-paint/web dev` - デモアプリ起動
3. 手動検証:
   - ペンでストローク描画
   - スクロール/回転/ズーム操作
   - 全体ビューに表示範囲が反映されること
   - デバッグパネルで数値確認

---

## 実装結果サマリー

**実装日:** 2026-01-31

### Phase 1: inputパッケージ基盤 ✅

| ファイル | 内容 |
|----------|------|
| `packages/input/src/types.ts` | `Point`, `ViewTransform`, `SamplingConfig`, `SamplingState` |
| `packages/input/src/transform.ts` | `createViewTransform`, `pan`, `zoom`, `rotate`, `invertViewTransform` |
| `packages/input/src/coordinate.ts` | `screenToLayer`, `layerToScreen` |
| `packages/input/src/sampling.ts` | `shouldAcceptPoint`, `createSamplingState` |
| `packages/input/src/index.ts` | 全APIエクスポート |
| `packages/input/package.json` | `gl-matrix` 依存追加 |

### Phase 2: engineパッケージ拡張 ✅

| ファイル | 内容 |
|----------|------|
| `packages/engine/src/render.ts` | `renderLayerWithTransform`, `renderLayers` |
| `packages/engine/src/index.ts` | render APIエクスポート追加 |

### Phase 3-4: デモアプリ ✅

| ファイル | 内容 |
|----------|------|
| `apps/web/src/hooks/useViewTransform.ts` | ビュー変換状態管理hook |
| `apps/web/src/hooks/usePointerHandler.ts` | ポインター入力 + 間引き処理hook |
| `apps/web/src/components/PaintCanvas.tsx` | ViewTransform対応キャンバス |
| `apps/web/src/components/Toolbar.tsx` | ペン/スクロール/回転/ズーム切替UI |
| `apps/web/src/components/Minimap.tsx` | 全体ビュー（赤枠で表示範囲表示） |
| `apps/web/src/components/DebugPanel.tsx` | lil-guiデバッグパネル |
| `apps/web/src/App.tsx` | 全コンポーネント統合 |
| `apps/web/package.json` | `lil-gui` 依存追加 |

### ドキュメント更新 ✅

| ファイル | 内容 |
|----------|------|
| `README.md` | プロジェクト概要・パッケージ構成 |
| `packages/engine/docs/README.md` | レンダリング関数セクション追加 |
| `packages/engine/docs/render-api.md` | レンダリングAPI仕様 |
| `packages/input/docs/README.md` | inputパッケージ概要 |
| `packages/input/docs/types.md` | 型定義仕様 |
| `packages/input/docs/transform-api.md` | ビュー変換API仕様 |
| `packages/input/docs/coordinate-api.md` | 座標変換API仕様 |
| `packages/input/docs/sampling-api.md` | 間引きAPI仕様 |

### ビルド・テスト結果

- ✅ `pnpm build` - 全パッケージビルド成功
- ✅ `pnpm test` - 19テストパス
