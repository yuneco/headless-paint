# ステップ1-2 実装計画 ✅ 完了

## 概要
マスタープランのステップ1（基礎型定義 + 最小レイヤー）とステップ2（最小描画 + Web表示）を実装する。

## 実装方針の変更

当初の計画から以下の変更を行った：

### 1. Canvas2Dベースに変更
- 当初: `Uint8ClampedArray` + Bresenhamアルゴリズム
- 変更後: `OffscreenCanvas` + Canvas2D API

**理由**: パフォーマンス検証の結果、手動ピクセル操作は大きなブラシサイズ（半径50px以上）で60fpsを維持できないことが判明。Canvas2DはGPUアクセラレーションにより100-2000倍高速。

### 2. 関数型アプローチに変更
- 当初: `Layer` クラス
- 変更後: `Layer` はデータ型、操作は関数

**理由**: クラスベースは神クラス問題を招きやすい。関数型にすることで状態の流れが明確になり、テストしやすくなる。

---

## ステップ1: 基礎型定義 + 最小レイヤー ✅

### 作成ファイル

#### 1. `packages/engine/src/types.ts`
基本型を定義：
```typescript
export interface Point { x: number; y: number; }
export interface Color { r: number; g: number; b: number; a: number; }
export interface StrokePoint extends Point { pressure?: number; }
export interface LayerMeta { name: string; visible: boolean; opacity: number; }
export interface Layer {
  readonly width: number;
  readonly height: number;
  readonly canvas: OffscreenCanvas;
  readonly ctx: OffscreenCanvasRenderingContext2D;
  readonly meta: LayerMeta;
}
```

#### 2. `packages/engine/src/layer.ts`
レイヤー操作関数：
```typescript
function createLayer(width, height, meta?): Layer
function clearLayer(layer): void
function getImageData(layer): ImageData
function getPixel(layer, x, y): Color
function setPixel(layer, x, y, color): void
function colorToStyle(color): string
```

#### 3. `packages/engine/src/layer.test.ts`
テストケース：10テスト
- createLayer: 4テスト（dimensions, default meta, custom meta, canvas/ctx存在）
- getPixel/setPixel: 4テスト（初期値、正常動作、境界外アクセス）
- getImageData: 1テスト
- clearLayer: 1テスト

### 達成基準
- [x] `pnpm test` でレイヤーテストが通る
- [x] `pnpm build` が成功

---

## ステップ2: 最小描画 + Web表示 ✅

### 作成ファイル

#### 1. `packages/engine/src/draw.ts`
描画関数（Canvas2D API使用）：
```typescript
function drawLine(layer, from, to, color, lineWidth?): void
function drawCircle(layer, center, radius, color): void
function drawPath(layer, points, color, lineWidth?): void
```

#### 2. `packages/engine/src/draw.test.ts`
テストケース：9テスト
- drawLine: 4テスト
- drawCircle: 3テスト
- drawPath: 2テスト

#### 3. `apps/web/src/components/Canvas.tsx`
```typescript
interface CanvasProps {
  imageData: ImageData;
}
export function Canvas({ imageData }: CanvasProps): JSX.Element;
```

#### 4. `apps/web/src/App.tsx`
- `createLayer(1920, 1080)` でレイヤー作成
- `drawLine()` でランダムな線を100本描画
- `getImageData(layer)` で取得して表示
- 描画時間を計測して表示

### 達成基準
- [x] `pnpm test` で描画テストが通る（19テスト全通過）
- [x] `pnpm dev` で画面に線が表示される
- [x] **視覚確認**: ブラウザで線が見える（アンチエイリアス付き）

---

## 最終ファイル構成

| ファイル | 内容 |
|---------|------|
| `packages/engine/src/types.ts` | 型定義（Point, Color, Layer等） |
| `packages/engine/src/layer.ts` | レイヤー操作関数 |
| `packages/engine/src/layer.test.ts` | レイヤーテスト（10テスト） |
| `packages/engine/src/draw.ts` | 描画関数（Canvas2D API） |
| `packages/engine/src/draw.test.ts` | 描画テスト（9テスト） |
| `packages/engine/src/index.ts` | エクスポート |
| `apps/web/src/components/Canvas.tsx` | Canvasコンポーネント |
| `apps/web/src/App.tsx` | デモアプリ |

---

## 検証結果

```bash
pnpm lint      # ✅ 19 files checked
pnpm test      # ✅ 19 tests passed
pnpm build     # ✅ All packages built
pnpm dev       # ✅ http://localhost:5174/ で線が表示される
```

---

## パフォーマンス検証メモ

### 手動実装 vs Canvas2D（100スタンプ、1920x1080）

| ブラシ半径 | 手動setPixel | Canvas2D arc |
|-----------|-------------|--------------|
| 10px | 2.31ms | <0.1ms |
| 20px | 9.02ms | <0.1ms |
| 50px | 56.37ms | <0.1ms |
| 100px | 229.47ms | <0.1ms |

→ Canvas2D採用を決定
