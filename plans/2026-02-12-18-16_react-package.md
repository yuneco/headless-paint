# `@headless-paint/react` パッケージ設計

## Context

headless-paint を React アプリに組み込む際、ストロークライフサイクル・履歴管理・レイヤー連携といったオーケストレーションコードはどの利用者も本質的に同じ実装になる。これを公式パッケージとして提供する。

headless の価値（UIの自由度、機能の取捨選択）を損なわないよう、hooks のみ提供し、コンポーネントは含めない。

## パッケージ設計

### アーキテクチャ: 段階的利用

利用者はアプリケーションの複雑さに応じて hooks を選択する:

- **ミニマル**: `useStrokeSession` + `usePointerHandler`（単一レイヤー描画）
- **中間**: `useStrokeSession` + `useLayers` + 自前の履歴
- **フル**: `usePaintEngine`（ストローク + レイヤー + 履歴 + wrap shift のオーケストレーション）

設定系 hooks（usePenSettings / useSmoothing / useExpand）は常に外部から渡す設計。アプリが設定 UI を完全に制御できる。

### パッケージ構成

```
packages/react/
  package.json          # peerDeps: engine, input, stroke, react
  tsconfig.json
  vite.config.ts
  src/
    index.ts            # 全パブリックエクスポート
    useStrokeSession.ts # ストロークライフサイクル hook
    usePaintEngine.ts   # オーケストレーション hook
    useViewTransform.ts
    useLayers.ts
    usePenSettings.ts   # 初期値を optional config で受け取る
    useSmoothing.ts     # 同上
    useExpand.ts
    usePointerHandler.ts
    useTouchGesture.ts
    useWindowSize.ts
  docs/
    README.md           # 利用者向け API ドキュメント
    INTERNALS.md        # 開発者/コントリビューター向け内部設計ガイド
```

### パッケージスコープ外

| 要素 | 理由 |
|------|------|
| キーボードショートカット | キーバインドはアプリ固有 |
| パターンプレビュー | ニッチ機能 |
| 背景設定 | engine 内部に無関係 |
| Canvas レンダリングコンポーネント | 描画方法はアプリが決める |
| UI コンポーネント全般 | Toolbar, LayerPanel, DebugPanel 等 |

### API 概要

詳細は `packages/react/docs/README.md` を参照。主要な hook:

- **useStrokeSession**: ストローク1本のライフサイクル（FilterPipeline, committed/pending 差分描画, pendingOnly モード）をカプセル化。`onStrokeComplete` コールバックで履歴連携のフックポイントを提供
- **usePaintEngine**: useStrokeSession + useLayers + 履歴 + wrap shift をオーケストレーション。不要な機能のコールバックを接続しなければ使わずに済む設計
- **usePenSettings / useSmoothing**: config.ts 依存を除去し、オプショナルな初期値引数で受け取る

## Doc-First Phase

### Phase 1: API設計・ドキュメント作成 ✅ 完了

成果物:
- `packages/react/package.json` + `tsconfig.json` + `vite.config.ts`
- `packages/react/docs/README.md` — 利用者向け API ドキュメント（全 hook の型定義 + TSDoc + 使い方）
- `packages/react/docs/INTERNALS.md` — 開発者向け内部設計ガイド（責務分担, Undo/Redo 設計, StrictMode 対応）
- `packages/react/src/index.ts` — エクスポート定義

### Phase 2: 利用イメージレビュー ✅ 完了（承認済み）

ミニマル構成とフル構成の利用コード例を提示し、API の妥当性を確認した。
利用イメージはこの計画の過去のコンテキストおよび `packages/react/docs/README.md` の使い方セクションに記載。

### Phase 3: 実装 ← 次回ここから

1. 既存 hooks の移動（useLayers, useViewTransform, usePenSettings, useSmoothing, useExpand, usePointerHandler, useTouchGesture, useWindowSize）
   - config.ts 依存の除去、初期値 optional 化
2. `useStrokeSession` 実装
3. `usePaintEngine` 実装
4. `apps/web` の移行（hook import 先変更 + App.tsx 簡略化）
5. ビルド確認 (`pnpm build`)
6. テスト実行 (`pnpm test`)
7. lint 確認 (`pnpm lint`)

### Phase 4: アーキテクトレビュー

- review-library-usage でセルフレビュー
- ドキュメント整合性チェック（双方向）
- Phase 4 通過で完了報告

## 検証方法

1. `pnpm build` - 全パッケージビルド成功
2. `pnpm test` - 全テスト通過
3. `pnpm dev` - デモアプリが移行後も同一動作することを確認
4. `pnpm lint` - lint エラーなし
